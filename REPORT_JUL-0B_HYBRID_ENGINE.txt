REPORTE DE INGENIERÍA: PROTOCOLO HYBRID ENGINE V2
--------------------------------------------------
AGENTE: Jules (JUL-0B)
FECHA: 2024
ASUNTO: Migración a Arquitectura Híbrida (Canvas + DOM)

1. MISIÓN EJECUTADA
   Se ha refactorizado el motor de visualización `WorldEngineV2` (`GraphSimulationV2.tsx`) para abandonar la renderización basada puramente en DOM/SVG y adoptar un modelo híbrido.

   - CAPA 0 (Fondo - Canvas): Renderiza las conexiones (Edges) y los territorios (Hulls) usando HTML5 Canvas API de alto rendimiento.
   - CAPA 1 (Frente - DOM): Mantiene los Nodos interactivos como elementos HTML `<div>` para preservar la facilidad de renderizado de texto, accesibilidad e interacción (clicks/hovers).

2. JUSTIFICACIÓN TÉCNICA (EL "POR QUÉ")
   - Cuello de Botella SVG: La implementación anterior usaba `react-xarrows` (SVG) para cada línea. Con >100 nodos y >300 conexiones, el DOM se saturaba, causando caídas de FPS drásticas al hacer pan/zoom.
   - Estética "Wuthering": Los "Energy Beams" (gradientes de color) son costosos en SVG pero triviales y performantes en Canvas (`createLinearGradient`).
   - Visión Macro: Se requería una visualización abstracta (Puntos + Territorios) al alejar la cámara. El Canvas permite dibujar formas complejas (`d3-polygon`) sin añadir cientos de nodos al DOM.

3. OBSTÁCULOS Y SOLUCIONES
   - Problema A: Coordenadas Negativas vs. Canvas.
     - Síntoma: La simulación D3 usaba (0,0) como centro, generando coordenadas negativas. El Canvas usa (0,0) arriba-izda.
     - Solución: Se mantuvo la lógica de D3 centrada en el contenedor padre (4000x4000) usando `forceCenter(2000, 2000)` implícito en la configuración inicial, alineando ambos sistemas.

   - Problema B: Acceso al Contexto en el Loop.
     - Síntoma: Error `width is not defined` dentro del `tick` de D3 debido a clausuras (closures) de Javascript.
     - Solución: Se extrajo `width` y `height` directamente del objeto `canvas` dentro del loop de renderizado, garantizando acceso seguro.

   - Problema C: Sincronización Reactiva vs. Imperativa.
     - Síntoma: El nivel de zoom (`lodTier`) no se actualizaba dentro de la simulación D3 al cambiar el estado de React.
     - Solución: Se implementó un `useRef` (`lodTierRef`) para mantener el valor actualizado accesible dentro del ciclo de animación de D3 sin reiniciar la simulación innecesariamente.

4. RECOMENDACIONES FUTURAS
   - WebGL (PixiJS/ThreeJS): Si el grafo supera los 5,000 nodos, el Canvas 2D empezará a sufrir. Se recomendaría migrar la Capa 0 a WebGL.
   - Hit Detection en Canvas: Actualmente la interacción es solo en los nodos DOM. Si se requiere clickear en las líneas (Edges), se necesitará implementar un sistema de "Color Picking" o Quadtree en el Canvas.

FIN DEL REPORTE.
