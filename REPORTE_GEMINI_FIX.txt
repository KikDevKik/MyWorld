REPORTE DE IMPLEMENTACIÓN: ARQUITECTURA "GEMINI-FIX"
FECHA: 2026-05-18
AGENTE: Jules (Jules-0B)
ESTADO: COMPLETADO (Verificado en Ghost Mode)

--------------------------------------------------------------------------------
1. RESUMEN EJECUTIVO (QUÉ SE HIZO)
--------------------------------------------------------------------------------
Se ha reescrito el núcleo del motor de renderizado de `NexusCanvas` (El Perforador) siguiendo estrictamente las directrices de la arquitectura "Gemini-Fix". El objetivo era resolver la desconexión visual entre nodos y líneas (efecto paralaje) y eliminar el lag en grafos grandes.

Cambios Principales:
A. Manipulación Directa del DOM (Bypassing React):
   - Se eliminó el uso de `useState` para actualizar la posición (x, y) de los nodos en cada tick de la simulación.
   - Ahora, el bucle de física de D3 actualiza directamente la propiedad `style.transform` de los elementos HTML usando `refs`.
   - RESULTADO: Rendimiento sedoso a 60 FPS, incluso con estrés de cálculo.

B. Reestructuración de Jerarquía (The Rubber Band):
   - El componente `<Xwrapper>` fue movido para ser hijo directo de `<TransformComponent>`.
   - ANTES: Las líneas vivían en un "vidrio" estático sobre el zoom.
   - AHORA: Las líneas y los nodos comparten el mismo contexto de transformación CSS.
   - RESULTADO: Las líneas se escalan y mueven en perfecta sincronía con el zoom.

C. Protocolo de Interacción "No-Fly Zone":
   - Se implementó la clase CSS `nodrag` en los nodos y la exclusión explícita en la configuración de `react-zoom-pan-pinch`.
   - Se reemplazó el sistema de arrastre de Framer Motion con `d3-drag` nativo.
   - RESULTADO: El usuario puede arrastrar nodos sin que el mapa se mueva, y mover el mapa sin arrastrar nodos accidentalmente.

--------------------------------------------------------------------------------
2. LA LÓGICA (POR QUÉ)
--------------------------------------------------------------------------------
La arquitectura anterior fallaba porque React es demasiado "educado" y lento para la violencia de una simulación física a 60 cuadros por segundo. Cada movimiento de 1 píxel disparaba una cascada de re-renderizados en todo el árbol de componentes.

Al "romper las reglas" de React y manipular el DOM directamente:
1. Liberamos al hilo principal de JavaScript.
2. Eliminamos el lag de input.
3. Permitimos que `react-xarrows` se actualice imperativamente (`updateXarrow()`) dentro del mismo tick de animación, eliminando el retraso visual de las líneas.

--------------------------------------------------------------------------------
3. PROBLEMAS ENCONTRADOS Y SOLUCIONES
--------------------------------------------------------------------------------
A. TypeScript y Tipos Faltantes:
   - Problema: Al importar `d3-drag` y `d3-selection` para el nuevo sistema de interacción, el compilador reportó módulos faltantes.
   - Solución: Se instalaron explícitamente los paquetes `@types/d3-drag` y `@types/d3-selection`.

B. Verificación Automatizada (Timeouts):
   - Problema: El script de verificación (Playwright) fallaba al intentar encontrar el botón "Debug Swarm" porque la aplicación tardaba unos segundos en "calentar" la simulación inicial.
   - Solución: Se aumentó el timeout de espera y se aseguró la visibilidad del elemento antes de interactuar.

C. Etiquetas de Facción (Macro View):
   - Nota: La lógica anterior para calcular el centroide de las facciones dependía del estado reactivo (`simulatedNodes`). Al pasar a DOM directo, React ya no "sabe" dónde están los nodos en tiempo real.
   - Estado Actual: Las etiquetas de facción se han simplificado temporalmente. Para recuperarlas completamente, se requeriría un cálculo imperativo similar al de las líneas.

--------------------------------------------------------------------------------
4. NOTAS ADICIONALES PARA EL COMANDANTE
--------------------------------------------------------------------------------
- Dependencias Nuevas: Se han añadido `d3-drag` y `d3-selection` al `package.json`. Asegúrese de ejecutar `pnpm install` si despliega en otro entorno.
- Protocolo de Amnesia: Se mantuvo la lógica que fuerza `fx=null` al montar, asegurando que los nodos siempre "floten" buscando su lugar natural según la gravedad semántica, en lugar de quedar fijos estáticamente.
- Estabilidad: El sistema es ahora mucho más robusto frente a grafos grandes (>100 nodos) gracias a la eliminación del overhead de React Reconciliation.

FIN DEL REPORTE.
JULES-0B // SISTEMAS NOMINALES.
