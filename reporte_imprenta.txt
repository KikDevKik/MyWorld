# üñ®Ô∏è REPORTE T√âCNICO: LA IMPRENTA (M√ìDULO DE EXPORTACI√ìN)
**Proyecto:** MyWord (Titanium Engine)
**Versi√≥n Actual:** v3.3 TITAN
**Fecha de An√°lisis:** 19/01/2026 (Seg√∫n Documentaci√≥n Maestra)
**Estado:** OPERATIONAL / BETA STABLE

---

## 1. RESUMEN EJECUTIVO
"La Imprenta" es el motor de compilaci√≥n y exportaci√≥n de manuscritos del sistema. Su funci√≥n principal es transformar una colecci√≥n dispersa de archivos Markdown (nodos narrativos) almacenados en Google Drive en un √∫nico documento PDF tipogr√°ficamente coherente y listo para lectura o revisi√≥n.

A diferencia de los exportadores tradicionales que simplemente concatenan texto, La Imprenta act√∫a como un **compositor inteligente**: entiende la estructura narrativa (cap√≠tulos, escenas), interpreta el formato Markdown y aplica reglas de maquetaci√≥n din√°mica en el servidor (Cloud Functions) para evitar sobrecargar el navegador del cliente.

---

## 2. ARQUITECTURA T√âCNICA

### A. Frontend (`src/components/ExportPanel.tsx`)
El panel de control act√∫a como una interfaz de mando para el "Tip√≥grafo". No procesa el PDF directamente, sino que prepara la "Orden de Trabajo".

*   **Interfaz de Usuario:** Dise√±o de doble panel (Split-Pane).
    *   **Zona A (Composici√≥n):** Un √°rbol de archivos recursivo (`CheckableTreeNode`) que permite seleccionar qu√© escenas incluir. Aplana la estructura jer√°rquica para crear una lista lineal de reproducci√≥n (compile order).
    *   **Zona B (Ajustes):** Configuraci√≥n de metadatos (T√≠tulo, Autor) y reglas de impresi√≥n.
*   **Gesti√≥n de Estado:** Utiliza `useState` local para el formulario y consume el `ProjectConfigContext` para acceder al √°rbol de archivos global (`fileTree`).
*   **Comunicaci√≥n:** Invoca la Cloud Function `compileManuscript` pasando un payload ligero (IDs de archivos + Token de Auth + Opciones). Recibe un string Base64 que convierte a `Blob URL` para la descarga inmediata.

### B. Backend (`functions/src/index.ts` -> `compileManuscript`)
El cerebro de la operaci√≥n. Se ejecuta en un entorno Node.js gestionado por Firebase Functions.

*   **Stack Tecnol√≥gico:**
    *   `pdfmake`: Motor de generaci√≥n de PDFs (Server-side).
    *   `marked`: Convierte el Markdown crudo de los archivos a HTML.
    *   `html-to-pdfmake`: Transforma el HTML en definiciones de objetos JSON que `pdfmake` entiende (estilos, m√°rgenes, pilas).
    *   `jsdom`: Simula un entorno DOM en el servidor, necesario para que `html-to-pdfmake` pueda parsear el HTML.
    *   `gray-matter`: Limpia el "Frontmatter" (metadatos YAML) de los archivos Markdown para que no aparezcan en el libro final.

---

## 3. L√ìGICA FUNCIONAL (NARRATIVA)

Imagina que La Imprenta es un taller editorial automatizado. El proceso sigue estos pasos:

1.  **La Recolecci√≥n (The Gathering):**
    El usuario selecciona las escenas en el Frontend. El backend recibe esta lista de IDs y usa las credenciales del usuario (`accessToken`) para "impersonar" al autor y descargar el contenido fresco directamente desde Google Drive. Esto garantiza que siempre se imprime la √∫ltima versi√≥n, sin problemas de cach√© local.

2.  **La Purificaci√≥n:**
    Cada archivo pasa por un filtro (`gray-matter`) que elimina las notas t√©cnicas del sistema (etiquetas, IDs, fechas) que suelen estar al principio de los archivos Markdown, dejando solo la prosa narrativa.

3.  **La Traducci√≥n (Markdown -> HTML -> PDF):**
    El texto plano se convierte primero en HTML (entendiendo negritas, cursivas, listas) y luego en un mapa de objetos vectoriales para el PDF.

4.  **La Inteligencia de Corte (Smart Breaks):**
    Aqu√≠ reside la magia de la v3.3. El sistema no solo pega el texto. Analiza recursivamente el contenido. Si detecta un T√≠tulo Principal (H1) o Secundario (H2) dentro del texto, inserta autom√°ticamente un "Salto de P√°gina" (`pageBreak: 'before'`) antes de ese t√≠tulo. Esto permite que el autor escriba varios cap√≠tulos en un solo archivo y que La Imprenta sepa separarlos correctamente en el papel.

---

## 4. HISTORIAL DE CAMBIOS Y EVOLUCI√ìN (RECONSTRUIDO)

Basado en el an√°lisis forense del c√≥digo y comentarios:

*   **v1.x (Inferencia):** Probablemente una exportaci√≥n simple de texto plano o concatenaci√≥n b√°sica en el cliente.
*   **v2.x (Migraci√≥n a Cloud):** Se movi√≥ la l√≥gica al servidor para soportar archivos grandes, pero depend√≠a de librer√≠as m√°s simples o no ten√≠a soporte para im√°genes/estilos complejos.
*   **v3.0 (Titanium Integration):** Integraci√≥n con el sistema de autenticaci√≥n de Google Drive (`accessToken`) para soportar archivos privados y seguros.
*   **v3.3 (Versi√≥n Actual):**
    *   **Smart Breaks:** Implementaci√≥n del algoritmo de detecci√≥n de cap√≠tulos (Headers H1/H2).
    *   **Recursive Checkboxes:** Mejora en el frontend para seleccionar carpetas enteras con un solo clic.
    *   **Sanitizaci√≥n:** Mejor manejo de errores de codificaci√≥n y caracteres nulos.

---

## 5. LIMITACIONES Y PROBLEMAS DETECTADOS

A pesar de ser funcional, el an√°lisis de c√≥digo revela varias limitaciones t√©cnicas (Technical Debt) y restricciones:

1.  **L√≠mite Duro de Archivos (Hard Cap):**
    El c√≥digo impone un l√≠mite de **50 archivos** por compilaci√≥n (`MAX_MANUSCRIPT_FILES = 50`). Esto es una protecci√≥n contra el *timeout* de las Cloud Functions (m√°x 9 minutos), pero impide compilar novelas enteras si est√°n muy fragmentadas (ej. 100 escenas cortas).

2.  **√çndice (TOC) Inoperativo:**
    Aunque existe la opci√≥n en el frontend, el backend tiene un placeholder expl√≠cito: `{ text: "(√çndice autogenerado no disponible en esta versi√≥n)", ... }`. La librer√≠a `pdfmake` soporta TOC, pero la implementaci√≥n actual es compleja debido a la conversi√≥n intermedia HTML->PDFMake y no se ha completado.

3.  **Fuentes Est√°ndar:**
    El sistema usa fuentes predeterminadas (Helvetica/Roboto). No hay soporte para incrustar fuentes personalizadas (ej. Garamond, Merriweather) para darle un aspecto m√°s "novelesco", ya que requerir√≠a cargar los archivos de fuente en el servidor, lo cual aumenta la latencia y el uso de memoria.

4.  **Memoria y Rendimiento:**
    La compilaci√≥n ocurre completamente en memoria RAM (`Buffer`). Si se intenta compilar un libro con muchas im√°genes o texto extremadamente largo, la funci√≥n podr√≠a colapsar por "Out of Memory" (OOM), ya que las instancias est√°ndar de Firebase suelen tener 256MB o 512MB de RAM (aunque la config solicita `2GiB`, esto depende del plan de facturaci√≥n).

5.  **Dependencia de `jsdom`:**
    El uso de `jsdom` en el servidor es pesado y lento. Es un "hack" necesario para que `html-to-pdfmake` funcione en Node.js, pero a√±ade un overhead significativo al tiempo de arranque de la funci√≥n (Cold Start).

---

## 6. CONCLUSI√ìN

La Imprenta v3.3 es una herramienta robusta para "Drafting" (borradores) y revisi√≥n. Cumple perfectamente su funci√≥n de sacar el texto del editor para leerlo en otro medio. Sin embargo, **no es una herramienta de maquetaci√≥n final** (Desktop Publishing). Para publicar un libro real, el autor a√∫n necesitar√≠a exportar el texto y llevarlo a software especializado (InDesign, Vellum).

**Recomendaci√≥n Inmediata:**
Si el usuario necesita compilar obras m√°s largas, se deber√≠a priorizar la implementaci√≥n de un sistema de "Streaming" o "Colas" para evitar el l√≠mite de 50 archivos y el riesgo de timeout.
