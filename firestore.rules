rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Force Update Timestamp: 2024-05-22T12:00:00Z

    // Â¡Â¡Â¡AQUÃ ESTÃ LA LLAVE!!!
    // Â¡BLOQUEA TODO por defecto! Â¡Nadie entra!
    match /{document=**} {
      allow read, write: if false;
    }

    // Â¡Â¡Â¡LA EXCEPCIÃ“N!!!
    // Â¡Solo permitimos que el USUARIO LOGUEADO (el Chasis)...
    // ...pueda LEER la colecciÃ³n "TDB_Index" de su PROPIO usuario!
    match /TDB_Index/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Â¡Â¡Â¡LA ESCRITURA SIGUE BLOQUEADA!!! Â¡Solo el "Motor" (backend) puede escribir!
    }

    // ğŸŸ¢ NUEVA REGLA PARA EL CRONOGRAMA (Intelligent Timeline)
    // Permitimos leer y escribir (para confirmar/borrar eventos desde la UI)
    match /TDB_Timeline/{userId}/events/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸŸ¢ REGLA PARA PERSONAJES (Soul Collector)
    // Permitimos al frontend leer y editar sus personajes
    match /users/{userId}/characters/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸŸ¢ REGLA PARA NEXUS GRAPH (World Engine)
    // Permitimos leer y escribir en la estructura de Proyectos y Entidades
    match /users/{userId}/projects/{projectId}/entities/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}