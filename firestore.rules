rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Force Update Timestamp: 2024-05-23T14:30:00Z

    // üü¢ GHOST MODE EXCEPTION (TEMPORARY FOR JULES)
    // Allows unauthenticated access to the Commander's specific data silo
    // NOTE: Write disabled for safety as per code review.
    match /users/1mImHC6_uFVo06QjqL-pFcKF-E6ufQUdq/{document=**} {
      allow read: if true;
    }

    // ¬°¬°¬°AQU√ç EST√Å LA LLAVE!!!
    // ¬°BLOQUEA TODO por defecto! ¬°Nadie entra!
    match /{document=**} {
      allow read, write: if false;
    }

    // ¬°¬°¬°LA EXCEPCI√ìN!!!
    // ¬°Solo permitimos que el USUARIO LOGUEADO (el Chasis)...
    // ...pueda LEER la colecci√≥n "TDB_Index" de su PROPIO usuario!
    match /TDB_Index/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // ¬°¬°¬°LA ESCRITURA SIGUE BLOQUEADA!!! ¬°Solo el "Motor" (backend) puede escribir!
    }

    // üü¢ NUEVA REGLA PARA EL CRONOGRAMA (Intelligent Timeline)
    // Permitimos leer y escribir (para confirmar/borrar eventos desde la UI)
    match /TDB_Timeline/{userId}/events/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // üü¢ REGLA MAESTRA ANIDADA (MATCHING FRONTEND TRUTH)
    // Coincide con la estructura: users/{userId}/projects/{projectId}/...
    match /users/{userId} {
      // Permite acceso al documento de usuario (opcional, pero buena pr√°ctica)
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ... Y a sus subcolecciones (como characters)
      match /characters/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // üü¢ PROYECTOS
      match /projects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // SUB-COLLECTION: ENTITIES (Confirmed in Report [4])
        match /entities/{entityId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // SUB-COLLECTION: EDGES (Critical for Purge Button [5])
        match /edges/{edgeId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // SUB-COLLECTION: SETTINGS (For Blacklist/Rencor Protocol)
        match /settings/{settingId} {
           allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }
  }
}
