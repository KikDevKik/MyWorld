rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Force Update Timestamp: 2024-05-22T12:00:00Z

    // ğŸŸ¢ GHOST MODE EXCEPTION (TEMPORARY FOR JULES)
    // Allows unauthenticated access to the Commander's specific data silo
    // NOTE: Write disabled for safety as per code review.
    match /users/1mImHC6_uFVo06QjqL-pFcKF-E6ufQUdq/{document=**} {
      allow read: if true;
    }

    // Â¡Â¡Â¡AQUÃ ESTÃ LA LLAVE!!!
    // Â¡BLOQUEA TODO por defecto! Â¡Nadie entra!
    match /{document=**} {
      allow read, write: if false;
    }

    // Â¡Â¡Â¡LA EXCEPCIÃ“N!!!
    // Â¡Solo permitimos que el USUARIO LOGUEADO (el Chasis)...
    // ...pueda LEER la colecciÃ³n "TDB_Index" de su PROPIO usuario!
    match /TDB_Index/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Â¡Â¡Â¡LA ESCRITURA SIGUE BLOQUEADA!!! Â¡Solo el "Motor" (backend) puede escribir!
    }

    // ğŸŸ¢ NUEVA REGLA PARA EL CRONOGRAMA (Intelligent Timeline)
    // Permitimos leer y escribir (para confirmar/borrar eventos desde la UI)
    match /TDB_Timeline/{userId}/events/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸŸ¢ REGLA PARA PERSONAJES (Soul Collector)
    // Permitimos al frontend leer y editar sus personajes
    match /users/{userId}/characters/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸŸ¢ REGLA PARA PROYECTOS (MyWorld / Nexus)
    // Estructura: users/{userId}/projects/{projectId}/entities/{entityId}
    match /users/{userId}/projects/{projectId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;

       match /entities/{entityId} {
         // ğŸŸ¢ PERMISO EXPLÃCITO PARA BORRAR Y EDITAR
         allow read, write, delete: if request.auth != null && request.auth.uid == userId;
       }

       match /edges/{edgeId} {
         // ğŸŸ¢ PERMISO EXPLÃCITO PARA BORRAR Y EDITAR EDGES
         allow read, write, delete: if request.auth != null && request.auth.uid == userId;
       }
    }
  }
}
