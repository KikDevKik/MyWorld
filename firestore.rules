rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Force Update Timestamp: 2024-05-23T14:30:00Z

    // üü¢ GHOST MODE EXCEPTION (TEMPORARY FOR JULES)
    // Allows unauthenticated access to the Commander's specific data silo
    // NOTE: Write disabled for safety as per code review.
    // üõ°Ô∏è SENTINEL FIX: Replaced recursive wildcard with explicit allowlist to prevent
    // exposure of sensitive subcollections like 'system_secrets' (Refresh Tokens).
    match /users/1mImHC6_uFVo06QjqL-pFcKF-E6ufQUdq {
      allow read: if true;

      match /characters/{document=**} { allow read: if true; }
      match /projects/{document=**} { allow read: if true; }
      match /profile/{document=**} { allow read: if true; }
      match /forge_detected_entities/{document=**} { allow read: if true; }
      match /file_locks/{document=**} { allow read: if true; }
    }

    // üü¢ PUBLIC CERTIFICATES (THE JUDGE)
    match /public_certificates/{certificateId} {
      allow read: if true; // Public Verification
      allow write: if false; // Only Cloud Function can write
    }

    // ¬°¬°¬°AQU√ç EST√Å LA LLAVE!!!
    // ¬°BLOQUEA TODO por defecto! ¬°Nadie entra!
    match /{document=**} {
      allow read, write: if false;
    }

    // ¬°¬°¬°LA EXCEPCI√ìN!!!
    // ¬°Solo permitimos que el USUARIO LOGUEADO (el Chasis)...
    // ...pueda LEER la colecci√≥n "TDB_Index" de su PROPIO usuario!
    match /TDB_Index/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // ¬°¬°¬°LA ESCRITURA SIGUE BLOQUEADA!!! ¬°Solo el "Motor" (backend) puede escribir!
    }

    // üü¢ NUEVA REGLA PARA EL CRONOGRAMA (Intelligent Timeline)
    // Permitimos leer y escribir (para confirmar/borrar eventos desde la UI)
    match /TDB_Timeline/{userId}/events/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // üü¢ REGLA MAESTRA ANIDADA (MATCHING FRONTEND TRUTH)
    // Coincide con la estructura: users/{userId}/projects/{projectId}/...
    match /users/{userId} {
      // Permite acceso al documento de usuario (opcional, pero buena pr√°ctica)
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ... Y a sus subcolecciones (como characters)
      match /characters/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // üü¢ PERFIL (Config & Settings)
      match /profile/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // üü¢ PROYECTOS
      match /projects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // SUB-COLLECTION: ENTITIES (Confirmed in Report [4])
        match /entities/{entityId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // SUB-COLLECTION: EDGES (Critical for Purge Button [5])
        match /edges/{edgeId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // SUB-COLLECTION: SETTINGS (For Blacklist/Rencor Protocol)
        match /settings/{settingId} {
           allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // üü¢ AUDIT LOG (Creative Audit Service)
        match /audit_log/{logId} {
           allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // üü¢ AUDIT STATS (The Spy's Memory)
        match /stats/{statId} {
           allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }

      // üü¢ FORGE DETECTED ENTITIES (Soul Sorter)
      match /forge_detected_entities/{entityId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // üü¢ FILE LOCKS (Mutex UI)
      match /file_locks/{lockId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
