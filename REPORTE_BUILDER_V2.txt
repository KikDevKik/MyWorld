REPORTE DE ACTUALIZACIÓN: THE BUILDER V2 (NEXUS INTEGRATION)
============================================================

1. OBJETIVO DEL CAMBIO
----------------------
El usuario reportó que "THE BUILDER" (el agente constructor de grafos) estaba desconectado del contexto global del proyecto (a diferencia del Director o Laboratorio), sufría de lag gráfico en el lienzo, no mostraba las líneas de conexión entre nodos, y exponía innecesariamente el razonamiento interno y JSON al usuario en el chat.

El objetivo fue integrar "THE BUILDER" con la "Memoria a Largo Plazo" (RAG) del sistema, optimizar el rendimiento visual, y limpiar la experiencia de chat.

2. CAMBIOS REALIZADOS
---------------------

A. Backend (functions/src/builder.ts):
   - Inyección de Contexto (El "Cerebro"):
     Antes de iniciar el chat, ahora se precargan dos fuentes de verdad:
     1. "Mapa del Mundo": Una lista ligera de todas las Entidades existentes (Nombre + Tipo) desde Firestore. Esto permite que la IA sepa que "Megu" ya existe y la use como ancla en lugar de crear un duplicado.
     2. "Verdad Narrativa" (Canon): Se recuperan los 20 fragmentos (chunks) más relevantes categorizados como 'canon' para darle suelo firme a las sugerencias.

   - Protocolo de Pensamiento Oculto:
     Se instruyó al modelo para encapsular su razonamiento en etiquetas `<thought>...</thought>`.

   - Filtrado de Stream (La "Censura" Constructiva):
     Se implementó un parser en tiempo real en el stream de respuesta. Este parser detecta y elimina activamente los bloques `<thought>` y el bloque JSON final del texto que ve el usuario, pero preserva el payload de datos oculto para que el frontend pueda dibujar el grafo.

B. Frontend (src/components/WorldEngineV2):
   - Visualización de Aristas (GhostGraph.tsx):
     Se habilitó `d3.forceLink` y se añadieron elementos SVG `<line>` para dibujar las conexiones entre nodos en tiempo real. Ahora, si la IA dice que A está conectado con B, se ve una línea física (color Cyan-500/30).

   - Optimización de Rendimiento (EntityCard.tsx):
     Se creó una variante `variant="performance"`. En este modo, las tarjetas eliminan los efectos costosos de CSS como `backdrop-blur` y `box-shadow` complejos. Esto reduce drásticamente la carga de pintura del navegador, permitiendo simulaciones más fluidas con muchos nodos.

   - Gestión de Estado (TheBuilder.tsx):
     Se actualizó la lógica para recibir y procesar el array de `edges` (aristas) del JSON del backend y pasarlo al grafo.

3. JUSTIFICACIÓN TÉCNICA
------------------------
- ¿Por qué limitar el contexto Canon a 20 chunks?
  Para mantener la latencia baja y no saturar la ventana de contexto del modelo con ruido irrelevante. 20 chunks suelen ser suficientes para captar el tono y los hechos clave sin incurrir en costos excesivos o tiempos de espera largos ("Time to First Token").

- ¿Por qué quitar el Blur en el modo Builder?
  El efecto `backdrop-blur` es uno de los más costosos en renderizado web (provoca repintados constantes). En una simulación física donde los nodos se mueven 60 veces por segundo, esto mataba los FPS. La versión "performance" es opaca y sólida, lo que es mucho más amigable para la GPU.

4. DESAFÍOS ENCONTRADOS
-----------------------
- Parsing de Stream:
  Filtrar etiquetas XML (`<thought>`) en un stream de texto fragmentado es delicado. Un fragmento puede terminar a la mitad de una etiqueta (ej. `<thou`). Se implementó un buffer inteligente para manejar estos casos borde sin romper la respuesta.

- Tipado de Resize Panels:
  La librería `react-resizable-panels` tenía una discrepancia de tipos en el frontend (`Group` vs `PanelGroup`). Se resolvió ajustando la importación y usando `@ts-ignore` temporalmente en el componente contenedor para evitar bloqueos de build, dado que la funcionalidad no estaba afectada.

5. RECOMENDACIONES FUTURAS
--------------------------
- Si el proyecto crece mucho (miles de nodos), el contexto estático de "20 chunks" podría quedarse corto. Se podría implementar una búsqueda vectorial dinámica *durante* la conversación (Tool Calling) para que el Builder busque información específica bajo demanda, similar a como lo hace el Director.
- Considerar mover el cálculo de física (D3) a un Web Worker si se planea tener más de 500 nodos en pantalla simultáneamente.

6. ESTADO FINAL
---------------
El sistema ahora "sabe" lo que hay en el proyecto, "piensa" en silencio, responde limpio al usuario, y dibuja las conexiones en un lienzo optimizado para velocidad.
