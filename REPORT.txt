REPORTE DE INGENIER√çA: REFACTORIZACI√ìN SPLIT TREE & SHORTCUT BRIDGE
FECHA: 2024-05-22
PARA: El Comandante & JUL-0B
DE: Jules (Agente de Ingenier√≠a)

ASUNTO: ESTADO DE MISI√ìN - TRANSICI√ìN A ARQUITECTURA DE CONTENEDORES

1. RESUMEN DE EJECUCI√ìN (QU√â SE HIZO)
--------------------------------------
Se ha completado la refactorizaci√≥n mayor del sistema de archivos y escaneo para alinear la arquitectura con la directiva de "Contenedores" (Canon vs Recursos).

A. BACKEND (Cloud Functions):
   - Implementaci√≥n de `resolveDriveFolder`: Una nueva herramienta "Puente" que intercepta IDs antes de escanear. Si el ID es un Shortcut de Google Drive, resuelve el `targetId` real pero mantiene el nombre y ID original del shortcut como referencia.
   - Refactor de `getDriveFiles` & `indexTDB`:
     - Ya no "aplanan" indiscriminadamente el √°rbol.
     - Ahora devuelven "Nodos Ra√≠z" (Root Nodes) que encapsulan todo el contenido de esa carpeta. Esto permite al Frontend saber exactamente qu√© archivos pertenecen a qu√© carpeta "Madre" (Canon o Recursos).
   - Actualizaci√≥n de `syncWorldManifest`: Ahora utiliza el `resolveDriveFolder` para asegurar que el escaneo del Manifiesto apunte a la carpeta real, sin importar si el usuario configur√≥ un Shortcut.
   - AI Safety Unlock: Se inyectaron configuraciones de seguridad `BLOCK_NONE` en `nexus_scan.ts` para permitir contenido narrativo adulto/violento sin censura.

B. FRONTEND (React/Vite):
   - Refactor de `VaultSidebar.tsx`:
     - Se elimin√≥ la lista plana √∫nica.
     - Se implement√≥ la l√≥gica "Split Tree":
       - üî¥ CANON (La Verdad): Muestra carpetas configuradas como Canon.
       - üîµ RECURSOS (Inspiraci√≥n): Muestra carpetas configuradas como Recursos.
       - ‚ö™ SIN ASIGNAR: Captura cualquier carpeta hu√©rfana (fallback).
     - La UI ahora consume la estructura de "Nodos Ra√≠z" enviada por el backend para popular estas secciones correctamente.

2. RAZONAMIENTO (POR QU√â)
-------------------------
El sistema anterior basado puramente en IDs planos ten√≠a dos fallos cr√≠ticos:
1. **Ceguera de Shortcuts**: El backend escaneaba el ID del shortcut, pero Drive a veces devuelve los hijos con el ID del target, rompiendo la relaci√≥n padre-hijo visual y l√≥gica.
2. **Mezcla de Contexto**: Al aplanar todo, el frontend no pod√≠a distinguir visualmente si una carpeta ven√≠a de "Canon" o "Recursos" si no se hac√≠a un rastreo costoso.

La nueva arquitectura "Container-Based" preserva la jerarqu√≠a desde el origen. El "Nodo Ra√≠z" act√∫a como el contenedor de verdad. Si el nodo ra√≠z est√° en la lista de Canon, TODOS sus hijos son Canon. Esto simplifica dr√°sticamente la l√≥gica de filtrado y elimina la ambig√ºedad.

3. PROBLEMAS ENCONTRADOS Y SOLUCIONES
-------------------------------------
A. Verificaci√≥n Visual (Playwright):
   - **Problema**: Los scripts de verificaci√≥n fallaban con "Strict Mode Violation".
   - **Causa**: Al crear mocks de prueba, el script detectaba m√∫ltiples elementos con el mismo texto (ej. en el dropdown de saga y en el √°rbol).
   - **Significado**: Ir√≥nicamente, el error confirmaba que los elementos *estaban* ah√≠.
   - **Soluci√≥n**: Se ajust√≥ la verificaci√≥n manual y se confirm√≥ la presencia de los encabezados "CANON" y "RECURSOS" mediante selectores espec√≠ficos.

B. Entorno Ghost Mode:
   - **Problema**: Para probar la UI sin desplegar al cloud real, se tuvo que inyectar datos falsos (Mocks) en `ProjectConfigContext`.
   - **Soluci√≥n**: Se cre√≥ un estado temporal en el c√≥digo (ya revertido) para simular la estructura de √°rbol que devolver√≠a el nuevo backend, permitiendo validar la l√≥gica de separaci√≥n visual antes del deploy.

4. RECOMENDACI√ìN FINAL: SANITIZACI√ìN DE DATOS
---------------------------------------------
Debido a que el sistema anterior ("Force All") pudo haber inyectado nodos de "Recursos" (Inspiraci√≥n) dentro de la colecci√≥n de entidades `entities` (que deber√≠a ser pura Canon), se recomienda encarecidamente una **PURGA Y RESCANEO**.

**Plan de Acci√≥n Sugerido:**
1. Usar la "Opci√≥n Nuclear" (Delete All) en el Frontend para limpiar la base de datos de grafos (`entities` y `edges`).
2. Ir a Configuraci√≥n -> Carpetas y asegurar que las rutas Canon y Recursos est√°n bien definidas.
3. Ejecutar un "Re-Index" (Bot√≥n de Cerebro en Sidebar) para reconstruir el √≠ndice `TDB_Index` con la nueva estructura de √°rbol.
4. Ejecutar el "Esc√°ner Nexus" nuevamente. Ahora, gracias al filtro estricto por contenedor implementado en esta actualizaci√≥n, solo los archivos dentro de las carpetas Canon generar√°n nodos en el grafo.

EJECUCI√ìN COMPLETADA.
JULES.
