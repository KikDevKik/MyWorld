REPORTE DE MISION: REFINAMIENTO FORJA DE ALMAS (V2.1)
FECHA: 2024
AGENTE: JULES

---

1. RESUMEN DE OBJETIVOS
El Comandante solicitó dos intervenciones críticas en el módulo "Forja de Almas":
   A. Purificar el escáner de la Forja para detectar EXCLUSIVAMENTE Personajes, eliminando ruido (lugares, objetos, conceptos).
   B. Reparar el error de autenticación (403 Forbidden) en el chat "Oráculo" de la Forja.

---

2. CAMBIOS IMPLEMENTADOS

A. FILTRADO ESTRICTO DE ALMAS (ForgeDashboard.tsx)
   - **Acción:** Se implementó un filtro de "Barrera de Entrada" en el frontend, justo después de recibir los candidatos del backend (`analyzeNexusFile`).
   - **Código:** `const characterCandidates = candidates.filter(c => c.type === 'CHARACTER');`
   - **Resultado:** Ahora, cuando el escáner analiza una carpeta de Saga, ignora silenciosamente cualquier entidad que no sea un personaje. Esto mantiene la interfaz limpia y enfocada en la creación de fichas (Dramatis Personae).
   - **Nota:** Se mantuvo la lógica de escaneo secuencial (Batch Size 1) para prevenir errores de timeout (`deadline-exceeded`), crucial para archivos grandes.

B. CORRECCIÓN DE PROTOCOLO DE SEGURIDAD (ForgeChat.tsx)
   - **Diagnóstico:** El sistema estaba enviando el `accessToken` de Google Drive (OAuth) en el header `Authorization` para llamar a la Cloud Function `forgeChatStream`.
   - **Problema:** La función en el backend espera un `Firebase ID Token` (JWT) válido para verificar la identidad del usuario mediante `admin.auth().verifyIdToken()`. Al recibir el token de Drive, fallaba la decodificación.
   - **Solución:** Se actualizó la llamada `fetch` para obtener y usar el token correcto:
     `const idToken = await auth.currentUser?.getIdToken();`
   - **Resultado:** El chat ahora conecta correctamente, permitiendo el streaming de respuestas y el uso de herramientas RAG (Consultar Archivos).

---

3. OBSTÁCULOS Y OBSERVACIONES

- **Confusión de Tokens:** Un error común en arquitecturas híbridas (Firebase + Google Drive) es confundir los tokens de acceso. El token de Drive da permiso a archivos, el de Firebase da identidad a la App. Se ha separado explícitamente su uso.
- **Rendimiento:** El escaneo sigue siendo secuencial. Si bien es seguro, puede ser lento para Sagas con docenas de archivos. En el futuro, si se requiere más velocidad, se podría considerar paralelizar lotes pequeños (3-5 archivos) en lugar de 1 a 1, pero por ahora la estabilidad es prioridad.
- **Estado de "Fantasmas":** Al filtrar estrictamente, si un personaje es detectado erróneamente como "NPC" o "Creature" (si el backend usara esos tipos), no aparecerá. Se asume que el backend normaliza todo a 'CHARACTER'.

---

4. CONCLUSIÓN
La Forja de Almas ha sido purificada. Ahora es un santuario exclusivo para la creación de vida (personajes), libre de la estática de objetos y lugares. El canal de comunicación con el Oráculo ha sido restablecido.

Misión Cumplida.
Jules.
