REPORTE DE ACCI√ìN SENTINEL - 2025-05-26
=========================================

OBJETIVO:
Mitigar una vulnerabilidad cr√≠tica de Seguridad (LFI / SSRF) en el m√≥dulo de compilaci√≥n de manuscritos (`compileManuscript`).

QU√â SE HIZO:
1. Se identific√≥ que la funci√≥n `sanitizeHtml` en `functions/src/utils/sanitizer.ts` permit√≠a etiquetas `<img>`.
2. Se demostr√≥ (mediante script de reproducci√≥n) que `pdfmake` y `html-to-pdfmake` en un entorno Node.js intentan resolver las rutas `src` de las im√°genes como archivos locales (`file:///etc/passwd`) o peticiones de red internas (`http://localhost...`).
3. Se modific√≥ `sanitizeHtml` para incluir expl√≠citamente `img`, `video`, `audio`, `picture` y `source` en la lista de etiquetas prohibidas (`prohibitedTags`).
4. Se verific√≥ que las etiquetas maliciosas ahora son eliminadas completamente del HTML antes de la conversi√≥n a PDF.

POR QU√â SE HIZO:
El motor de generaci√≥n de PDFs (`pdfmake` sobre `pdfkit`) tiene acceso al sistema de archivos local del servidor cuando se ejecuta en Node.js. Si un usuario malintencionado inyectara un Markdown con una imagen apuntando a un archivo sensible del sistema, el PDF generado podr√≠a contener el contenido de ese archivo (Local File Inclusion). Tambi√©n podr√≠a usarse para escanear puertos internos (SSRF). La sanitizaci√≥n es la √∫nica barrera efectiva en este nivel.

PROBLEMAS ENCONTRADOS:
1. **Entorno de Ejecuci√≥n TypeScript:** Ejecutar scripts de prueba aislados (`repro_sanitizer.ts`) dentro de la carpeta `functions` fue complicado debido a la falta de configuraci√≥n de `ts-node` y dependencias de tipos (`@types/jsdom`, `typescript`).
   - *Soluci√≥n:* Se opt√≥ por compilar el proyecto completo con `pnpm build` y ejecutar el archivo JavaScript generado (`node lib/scripts/...`), lo cual es m√°s fiel al entorno de producci√≥n.
2. **Dependencias:** Hubo advertencias de `pnpm` sobre scripts de construcci√≥n ignorados, pero no afectaron la compilaci√≥n final.

REFLEXIONES Y RECOMENDACIONES ADICIONALES:
1. **P√©rdida de Funcionalidad:** Esta correcci√≥n deshabilita efectivamente la inclusi√≥n de im√°genes en los manuscritos PDF. Si esta funcionalidad es cr√≠tica para el producto, NO se debe revertir este parche. En su lugar, se debe implementar un "Proxy de Im√°genes Seguro":
   - Una funci√≥n que descargue la imagen, verifique su tipo MIME (asegurando que es realmente una imagen), la redimensione (para evitar bombas de descompresi√≥n) y la sirva desde un buffer seguro.
   - O usar una lista blanca estricta de dominios (ej: solo `storage.googleapis.com`).
2. **Revisi√≥n Continua:** Se recomienda auditar cualquier otra librer√≠a que procese HTML o XML (como analizadores de EPUB o DOCX) para asegurar que las entidades externas (XXE) tambi√©n est√©n deshabilitadas.

Firmado,
Sentinel üõ°Ô∏è
